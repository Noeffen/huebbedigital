<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bestellungen - FairwayService Admin</title>
  <link rel="stylesheet" href="admin-styles.css">
  <style>
    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: #f9fafb;
    }
    .filter-btn.active {
      background: var(--green-primary);
      color: white;
      border-color: var(--green-primary);
    }
    .filter-divider {
      width: 1px;
      height: 24px;
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <header class="admin-header">
    <div class="container header-content">
      <a href="dashboard.html" class="logo">Fairway<span class="logo-green">Service</span></a>
      <div class="user-info"><span id="userEmail"></span><button class="btn-logout" id="logoutBtn">Abmelden</button></div>
    </div>
  </header>
  <div class="container">
    <nav class="nav-tabs">
      <button class="nav-tab" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="nav-tab active">Bestellungen</button>
      <button class="nav-tab" onclick="location.href='products.html'">Produkte</button>
      <button class="nav-tab" onclick="location.href='issues.html'">Meldungen</button>
      <button class="nav-tab" onclick="location.href='settings.html'">Einstellungen</button>
    </nav>
  </div>
  <main class="container">
    <div class="card">
      <h3 class="card-title">Bestellungen</h3>
      
      <!-- Filter Bar -->
      <div class="filter-bar">
        <button class="filter-btn active" data-status="all">ğŸ“‹ Alle</button>
        <button class="filter-btn" data-status="neu">ğŸ†• Neu</button>
        <button class="filter-btn" data-status="preparing">ğŸ‘¨â€ğŸ³ In Arbeit</button>
        <button class="filter-btn" data-status="ready">âœ… Bereit</button>
        <button class="filter-btn" data-status="completed">âœ”ï¸ Abgeschlossen</button>
        <div class="filter-divider"></div>
        <button class="filter-btn active" data-type="all">ğŸ½ï¸ Alle</button>
        <button class="filter-btn" data-type="gastro">ğŸ” Gastro</button>
        <button class="filter-btn" data-type="shop">ğŸ›’ Shop</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Typ</th>
            <th>Kunde</th>
            <th>Loch</th>
            <th>Produkte</th>
            <th>Betrag</th>
            <th>Status</th>
            <th>Zeit</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" style="text-align:center;padding:40px;">Lade...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script>
    firebase.initializeApp({apiKey:"AIzaSyCDEWPkL9wEQ7C_as-GM74d0u8KbLYm47w",authDomain:"fairwayservice-768e9.firebaseapp.com",projectId:"fairwayservice-768e9",storageBucket:"fairwayservice-768e9.firebasestorage.app",messagingSenderId:"621650445863",appId:"1:621650445863:web:303dde082c00db6a867002"});
    const auth=firebase.auth(),db=firebase.firestore(),clubId=localStorage.getItem('adminClubId');
    
    let allOrders=[];
    let currentStatusFilter='all';
    let currentTypeFilter='all';

    auth.onAuthStateChanged(u=>{if(!u||!clubId)location.href='index.html';else{document.getElementById('userEmail').textContent=u.email;loadOrders();}});
    document.getElementById('logoutBtn').onclick=async()=>{await auth.signOut();localStorage.clear();location.href='index.html';};

    // Filter Buttons
    document.querySelectorAll('[data-status]').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('[data-status]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentStatusFilter=btn.dataset.status;
        renderOrders();
      };
    });

    document.querySelectorAll('[data-type]').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('[data-type]').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        currentTypeFilter=btn.dataset.type;
        renderOrders();
      };
    });

    function loadOrders(){
      db.collection('clubs').doc(clubId).collection('orders')
        .orderBy('createdAt','desc')
        .limit(100)
        .onSnapshot(s=>{
          allOrders=s.docs.map(d=>({id:d.id,...d.data()}));
          renderOrders();
        });
    }

    function renderOrders(){
      const filtered=allOrders.filter(o=>{
        const statusMatch=currentStatusFilter==='all'||o.status===currentStatusFilter;
        const typeMatch=currentTypeFilter==='all'||o.type===currentTypeFilter;
        return statusMatch&&typeMatch;
      });

      const tbody=document.getElementById('tbody');
      
      if(!filtered.length){
        tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;">Keine Bestellungen</td></tr>';
        return;
      }

      const badges={
        neu:'<span class="badge badge-warning">ğŸ†• Neu</span>',
        preparing:'<span class="badge badge-info">ğŸ‘¨â€ğŸ³ In Arbeit</span>',
        ready:'<span class="badge badge-success">âœ… Bereit</span>',
        completed:'<span class="badge badge-success">âœ”ï¸ Fertig</span>'
      };

      tbody.innerHTML=filtered.map(o=>{
        const type=o.type==='gastro'?'ğŸ” Gastro':'ğŸ›’ Shop';
        const items=(o.items||[]).map(i=>`${i.name} (${i.qty||i.quantity}x)`).join(', ')||'-';
        const time=o.createdAt?.toDate().toLocaleString('de-DE',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})||'-';
        const hole=o.deliveryMethod==='delivery'&&o.hole?`<strong>ğŸŒï¸ Loch ${o.hole}</strong>`:'<span style="color:#9ca3af;">-</span>';
        
        return `<tr>
          <td>${type}</td>
          <td>${o.userName||'Gast'}</td>
          <td>${hole}</td>
          <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${items}">${items}</td>
          <td><strong>â‚¬${(o.total||0).toFixed(2)}</strong></td>
          <td>${badges[o.status]||o.status}</td>
          <td style="white-space:nowrap;">${time}</td>
          <td>
            <select class="form-select" style="padding:6px;font-size:13px;" onchange="updateStatus('${o.id}',this.value)" ${o.status==='completed'?'disabled':''}>
              <option value="neu" ${o.status==='neu'?'selected':''}>ğŸ†• Neu</option>
              <option value="preparing" ${o.status==='preparing'?'selected':''}>ğŸ‘¨â€ğŸ³ In Arbeit</option>
              <option value="ready" ${o.status==='ready'?'selected':''}>âœ… Bereit</option>
              <option value="completed" ${o.status==='completed'?'selected':''}>âœ”ï¸ Fertig</option>
            </select>
          </td>
        </tr>`;
      }).join('');
    }

    window.updateStatus=async(id,status)=>{
      try{
        await db.collection('clubs').doc(clubId).collection('orders').doc(id).update({status});
      }catch(e){
        console.error(e);
        alert('Fehler beim Status-Update');
      }
    };
  </script>
</body>
</html>
